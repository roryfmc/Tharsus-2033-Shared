{% extends "base.html" %}

{% block content %}
<script>
    const toggleRow = (element) => {
      let x = element.getElementsByClassName('expanded-row-content');
      for (let i = 0; i < x.length; i++){
          x[i].classList.toggle('hide-row');
      }
    }

    function liveSearch() {
        let fields = document.querySelectorAll('.is-parent');
        let search_query = document.getElementById("searchbox").value;

        for (var i = 0; i < fields.length; i++) {
            if(fields[i].querySelectorAll("th")[1].innerText.toLowerCase()
            .includes(search_query.toLowerCase())) {
                fields[i].classList.remove("is-hidden");
            } else {
                fields[i].classList.add("is-hidden");
            }
        }

        let typingTimer;
        let typeInterval = 200;
        let searchInput = document.getElementById('searchbox');

        searchInput.addEventListener('keyup', () => {
            clearTimeout(typingTimer);
            typingTimer - setTimeout(liveSearch, typeInterval);
        });
    }
</script>
<style>
    .styled_table {
        font-size: 1em;
        font-family: sans-serif;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        border-collapse: collapse;
        border-bottom: 2px solid #009879;
        table-layout: fixed;
    }

    .styled_table tbody tr:nth-of-type(even) {
        background-color: #f3f3f3;
    }

    tr {
        cursor: pointer;
        grid-template-columns: repeat(3, 1fr);
        justify-content: flex-start;
    }

    td {
        text-align: center!important;
        position: relative;
    }

    tbody tr:hover {
        background-color: #EEF4FD;
    }

    .expanded-row-content {
        border-top: none;
        grid-column: 1/-1;
        justify-content: flex-start;
    }

    .hide-row {
        display: none;
    }

    .part-name{
        border: none!important;
    }

    thead {
        background-color: #009879;
    }

    th {
        color: white!important;
        text-align: center!important;
    }

    #col {
        background-color: rgba(255, 255, 255, 0.40);
        border-radius: 25px;
    }

    .is-hidden {
        display: none;
    }

    .part-title {
        color: white!important;
    }

    .part-title:hover {
        background-color: rgba(255,255,255,0.3)!important;
    }

    .dropdown-item {
        font-size: 0.9em;
    }

    .dropdown-menu {
        padding-top: 0px!important;
        left: -50% !important;
    }

    .go-to-page:hover {
        background-color: rgba(82, 200, 11, 0.55);
    }

    .favourite-supplier:hover{
        background-color: rgba(255, 255, 0, 0.55);
    }

    .blacklist-supplier:hover{
        background-color: rgba(255, 0, 0, 0.55);
    }


</style>
<h4 class="title is-4">Search</h4>
<div class="columns is-multiline is-centered" id="col">
    <div class="column is-1">
        <a class="button is-light is-rounded" href="{{ url_for('search.search') }}">Back to search</a>
    </div>
    <div class="column is-4"></div>
    <div class="column is-2">
        <input class="input" type="text" oninput="liveSearch()" id="searchbox" placeholder="Find a part">
    </div>
    <div class="column is-3"></div>
    <div class="column is-2">
        <a class="button is-light is-rounded" href="{{ url_for('search.export') }}">Export to excel</a>
    </div>
    {% if search_results %}
        {% for part in search_results %}
                    <div class="field column is-4">
                        <div class="tile is-parent is-vertical">
                            <div class="tile is-child" name="{{ loop.index }}">
                                <table class="table is-fullwidth styled_table" onclick="toggleRow(this)">
                                    <thead>
                                    <tr>
                                        <th class="part-name"></th>
                                        <th class="part-name">
                                            <a href="{{ url_for('search.part', part_count=loop.index) }}" class="button is-text part-title">{{ part.name }}</a>
                                        </th>
                                        <th class="part-name"></th>
                                    </tr>
                                    <tr>
                                        <th>Supplier</th>
                                        <th>Stock</th>
                                        <th>Price</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for supplier in part.suppliers %}
                                        {% if supplier == part.suppliers[0] %}
                                        <tr>
                                            <td class="dropdown is-hoverable dropdown-trigger">
                                                <a>
                                                    {{ supplier.name }}
                                                </a>
                                                <div class="dropdown-menu" role="menu">
                                                    <div class="dropdown-content">
                                                        <div class="go-to-page dropdown-item">
                                                            <a href="{{ supplier.link }}">Go to page</a>
                                                        </div>
                                                        <div class="favourite-supplier dropdown-item">
                                                            <a href="#">Favourite supplier</a>
                                                        </div>
                                                        <div class="blacklist-supplier dropdown-item">
                                                            <a href="#">Blacklist Supplier</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ supplier.stock}}</td>
                                            <td>{{ supplier.price}}</td>
                                        </tr>
                                        {% else %}
                                        <tr name="hidden-rows" class="expanded-row-content hide-row">
                                            <td class="dropdown is-hoverable dropdown-trigger">
                                                <a href="{{ supplier.link }}">
                                                    {{ supplier.name }}
                                                </a>
                                                <div class="dropdown-menu" role="menu">
                                                    <div class="dropdown-content">
                                                        <div class="go-to-page dropdown-item">
                                                            <a href="{{ supplier.link }}">Go to page</a>
                                                        </div>
                                                        <div class="favourite-supplier dropdown-item">
                                                            <a href="#">Favourite supplier</a>
                                                        </div>
                                                        <div class="blacklist-supplier dropdown-item">
                                                            <a href="#">Blacklist Supplier</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ supplier.stock }}</td>
                                            <td>{{ supplier.price }}</td>
                                        </tr>
                                        {% endif %}

                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
        {% endfor %}
    {% endif %}
</div>

{% endblock %}